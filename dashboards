const DB_KEY = "ssc_db_v1";
const SESSION_KEY = "ssc_session_v1";

function loadDB(){ return JSON.parse(localStorage.getItem(DB_KEY) || "{}"); }
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function nowISO(){ return new Date().toISOString(); }
function getSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function clearSession(){ localStorage.removeItem(SESSION_KEY); }
function $(s){ return document.querySelector(s); }

function seedIfNeeded(){
  if (localStorage.getItem(DB_KEY)) return;
  // if user opened dashboards directly without visiting home
  location.href = "../";
}

function resetDemo(){
  localStorage.removeItem(DB_KEY);
  localStorage.removeItem(SESSION_KEY);
  location.href = "../";
}

function roleName(role){
  return ({school:"Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", doctor:"Ø§Ù„Ø·Ø¨ÙŠØ¨", parent:"ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±"}[role]) || role;
}

function consentLabel(v){
  return ({pending:"Ø¨Ø§Ù†ØªØ¸Ø§Ø±", approved:"Ù…ÙˆØ§ÙÙ‚", rejected:"Ù…Ø±ÙÙˆØ¶"}[v]) || "â€”";
}

function canSeeTicket(session, ticket, db){
  if (session.role === "school") return true;
  if (session.role === "doctor") return ticket.assignedDoctorId === session.userId;
  if (session.role === "parent"){
    const me = db.users.find(u=>u.id===session.userId);
    return me?.studentId && ticket.studentId === me.studentId;
  }
  return false;
}

function buildRows(session, db){
  return db.tickets
    .filter(t => canSeeTicket(session, t, db))
    .map(t => {
      const st = db.students.find(s=>s.id===t.studentId);
      return {
        ...t,
        studentName: st ? `${st.name} (${st.grade})` : t.studentId,
        parentConsentLabel: consentLabel(t.parentConsent),
      };
    });
}

function computeKPIs(session, db, rows){
  const open = rows.filter(t=> t.status !== "Ù…ØºÙ„Ù‚Ø©");
  const waiting = open.filter(t=> t.status.includes("Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨")).length;
  const pending = open.filter(t=> t.parentConsent === "pending").length;
  const high = open.filter(t=> t.triage === "Ø¹Ø§Ù„ÙŠ").length;

  const kpisEl = $("#kpis");
  kpisEl.innerHTML = [
    kpiBox(open.length, "Ù…ÙØªÙˆØ­Ø©"),
    kpiBox(waiting, "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨"),
    kpiBox(pending, "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø©"),
    kpiBox(high, "Ø¹Ø§Ù„ÙŠ"),
  ].join("");
}

let CURRENT_TICKET_ID = null;

function openModal(ticketId, session, db){
  CURRENT_TICKET_ID = ticketId;
  const t = db.tickets.find(x=>x.id===ticketId);
  const st = db.students.find(s=>s.id===t.studentId);
  const doctor = db.users.find(u=>u.id===t.assignedDoctorId);

  $("#mTitle").textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© â€” ${st?.name || t.studentId}`;
  const notes = (t.notes||[]).map(n=>`<li><b>${new Date(n.at).toLocaleString("ar-SA")}</b> â€” ${n.text}</li>`).join("");

  $("#mBody").innerHTML = `
    <div class="cols3">
      <div class="card" style="padding:12px">
        <div class="muted">Ø§Ù„Ø·Ø§Ù„Ø¨</div>
        <div><b>${st ? st.name : t.studentId}</b></div>
        <div class="small">${st?.grade || "â€”"} â€” ${st?.school || "â€”"}</div>
      </div>
      <div class="card" style="padding:12px">
        <div class="muted">Ø§Ù„ÙØ±Ø² / Ø§Ù„Ø­Ø§Ù„Ø©</div>
        <div>${tag(t.triage)} ${tag(t.status)}</div>
        <div class="small">Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±: ${tag(consentLabel(t.parentConsent))}</div>
      </div>
      <div class="card" style="padding:12px">
        <div class="muted">Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†</div>
        <div><b>${doctor?.name || "â€”"}</b></div>
        <div class="small">(${doctor?.email || "â€”"})</div>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="card" style="padding:12px">
      <div class="muted">Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</div>
      <div><b>${esc(t.symptoms)}</b></div>
    </div>

    <div style="height:10px"></div>

    <div class="card" style="padding:12px">
      <div class="muted">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
      <ul class="list">${notes || "<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯</li>"}</ul>

      <div style="height:10px"></div>
      <label>Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©
        <input id="noteInput" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø©â€¦" />
      </label>
      <button class="btn" id="addNoteBtn">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  `;

  // Permissions for buttons
  const isDoctor = session.role === "doctor";
  const isSchool = session.role === "school";
  const isParent = session.role === "parent";

  $("#btnStartCall").style.display = isDoctor ? "inline-block" : "none";
  $("#btnAskConsent").style.display = (isDoctor || isSchool) ? "inline-block" : "none";
  $("#btnResolve").style.display = (isDoctor || isSchool) ? "inline-block" : "none";

  // Parent consent controls (parent sees consent buttons)
  const consentAreaId = "consentArea";
  const parentUI = `
    <div style="height:10px"></div>
    <div class="card" style="padding:12px" id="${consentAreaId}">
      <div class="muted">Ù‚Ø±Ø§Ø± ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</div>
      <div class="row">
        <button class="btn primary" id="approveBtn">Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button class="btn danger" id="rejectBtn">Ø±ÙØ¶</button>
      </div>
      <div class="small">* Ø§Ù„Ù‚Ø±Ø§Ø± ÙŠÙ†Ø¹ÙƒØ³ ÙÙˆØ±Ù‹Ø§ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØ§Ù„Ù…Ø¯Ø±Ø³Ø©.</div>
    </div>
  `;
  if (isParent){
    $("#mBody").insertAdjacentHTML("beforeend", parentUI);
  }

  $("#backdrop").style.display = "flex";

  // add note
  $("#addNoteBtn").onclick = ()=>{
    const inp = $("#noteInput");
    const text = inp.value.trim();
    if(!text) return;
    const t2 = db.tickets.find(x=>x.id===ticketId);
    t2.notes = t2.notes || [];
    t2.notes.push({at: nowISO(), by: session.userId, text});
    saveDB(db);
    render(session); // re-render everything
    openModal(ticketId, session, loadDB()); // reopen with updated data
  };

  if (isParent){
    $("#approveBtn").onclick = ()=>{
      const db2 = loadDB();
      const t2 = db2.tickets.find(x=>x.id===ticketId);
      t2.parentConsent = "approved";
      t2.status = "Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡ â€” Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©";
      saveDB(db2);
      render(session);
      closeModal();
    };
    $("#rejectBtn").onclick = ()=>{
      const db2 = loadDB();
      const t2 = db2.tickets.find(x=>x.id===ticketId);
      t2.parentConsent = "rejected";
      t2.status = "Ù…Ø±ÙÙˆØ¶ Ù…Ù† ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±";
      saveDB(db2);
      render(session);
      closeModal();
    };
  }
}

function closeModal(){
  $("#backdrop").style.display = "none";
  CURRENT_TICKET_ID = null;
}

function startCall(ticketId, session){
  const db = loadDB();
  const call = db.calls.find(c=>c.ticketId===ticketId) || null;
  const t = db.tickets.find(x=>x.id===ticketId);

  if (t.parentConsent !== "approved"){
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ù‚Ø¨Ù„ Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±.");
    return;
  }

  if (call){
    call.status = "in_progress";
    call.startedAt = call.startedAt || nowISO();
  } else {
    db.calls.push({
      id: "c_" + Math.random().toString(16).slice(2,10),
      ticketId, startedAt: nowISO(), endedAt:null,
      status:"in_progress", doctorId: session.userId,
      parentUserId: db.users.find(u=>u.role==="parent" && u.studentId===t.studentId)?.id
    });
  }

  t.status = "Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø±Ø¦ÙŠØ© Ø¬Ø§Ø±ÙŠØ© (Ù…Ø­Ø§ÙƒØ§Ø©)";
  t.notes = t.notes || [];
  t.notes.push({at: nowISO(), by: session.userId, text:"ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© (Ù…Ø­Ø§ÙƒØ§Ø©)."});
  saveDB(db);

  alert("ğŸ¥ ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© (Ù…Ø­Ø§ÙƒØ§Ø©). ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù†Ø±Ø¨Ø· WebRTC.");
  render(session);
  closeModal();
}

function askConsent(ticketId, session){
  const db = loadDB();
  const t = db.tickets.find(x=>x.id===ticketId);
  t.parentConsent = "pending";
  t.status = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±";
  t.notes = t.notes || [];
  t.notes.push({at: nowISO(), by: session.userId, text:"ØªÙ… Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©."});
  saveDB(db);
  render(session);
  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© (Ù…Ø­Ø§ÙƒØ§Ø©).");
  closeModal();
}

function resolveTicket(ticketId, session){
  const db = loadDB();
  const t = db.tickets.find(x=>x.id===ticketId);
  t.status = "Ù…ØºÙ„Ù‚Ø©";
  t.notes = t.notes || [];
  t.notes.push({at: nowISO(), by: session.userId, text:"ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø§Ù„Ø©."});
  saveDB(db);
  render(session);
  closeModal();
}

function render(session){
  const db = loadDB();
  const rows = buildRows(session, db);

  $("#sub").textContent = `Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…ÙØ¹Ù„ â€” Ø¯ÙˆØ±Ùƒ: ${roleName(session.role)}`;
  $("#who").textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ${session.name}`;
  $("#roleLine").textContent = `Ø§Ù„Ø¯ÙˆØ±: ${roleName(session.role)} â€” (${session.email})`;

  computeKPIs(session, db, rows);

  $("#ticketsTable").innerHTML = tableTickets(rows);

  // Bind open buttons
  document.querySelectorAll("[data-open]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-open");
      const db2 = loadDB();
      openModal(id, session, db2);
    });
  });

  // Modal action buttons (bind once via onclick)
  $("#btnStartCall").onclick = ()=> CURRENT_TICKET_ID && startCall(CURRENT_TICKET_ID, session);
  $("#btnAskConsent").onclick = ()=> CURRENT_TICKET_ID && askConsent(CURRENT_TICKET_ID, session);
  $("#btnResolve").onclick = ()=> CURRENT_TICKET_ID && resolveTicket(CURRENT_TICKET_ID, session);
}

(function init(){
  seedIfNeeded();
  const session = getSession();
  if(!session){
    location.href = "../";
    return;
  }

  $("#logoutBtn").addEventListener("click", ()=>{
    clearSession();
    location.href = "../";
  });

  $("#refreshBtn").addEventListener("click", ()=> render(session));
  $("#resetBtn").addEventListener("click", ()=> resetDemo());
  $("#closeModal").addEventListener("click", closeModal);
  $("#backdrop").addEventListener("click", (e)=>{
    if (e.target.id === "backdrop") closeModal();
  });

  render(session);
})();
